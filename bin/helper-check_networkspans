#!/bin/sh

if [ -z "$CHECK_NETWORKSPANS_DURATION" ]; then
	export CHECK_NETWORKSPANS_DURATION=120
fi
if [ ! -z "$CHECK_NETWORKSPANS_DEBUG" ]; then
	echo "DEBUG: CHECK_NETWORKSPANS_DURATION=$CHECK_NETWORKSPANS_DURATION"
fi

if [ -z "$CHECK_NETWORKSPANS_PACKETS" ]; then
	export CHECK_NETWORKSPANS_PACKETS=10000
fi
if [ ! -z "$CHECK_NETWORKSPANS_DEBUG" ]; then
	echo "DEBUG: CHECK_NETWORKSPANS_PACKETS=$CHECK_NETWORKSPANS_PACKETS"
fi

if [ -z "$CHECK_NETWORKSPANS_DIR" ]; then
	echo "env CHECK_NETWORKSPANS_DIR is not set"
	exit 1;
else
	if [ ! -d "$CHECK_NETWORKSPANS_DIR" ]; then
		echo "$CHECK_NETWORKSPANS_DIR does not exist or is not a directory"
	fi
fi
cd "$CHECK_NETWORKSPANS_DIR"
if [ $? -ne 0 ]; then
	echo "FAILED TO CD TO CHECK_NETWORKSPANS_DIR, $CHECK_NETWORKSPANS_DIR"
	exit;
fi
if [ ! -z "$CHECK_NETWORKSPANS_DEBUG" ]; then
	echo "DEBUG: CHECK_NETWORKSPANS_DIR=$CHECK_NETWORKSPANS_DIR"
fi

flags_for_i=''
for interface in `echo "$CHECK_NETWORKSPANS_INTERFACES"`; do
	flags_for_i="$flags_for_i -i $interface"
done

make_tshark_quiet=''
if [ ! -z "$CHECK_NETWORKSPANS_DEBUG" ]; then
	echo "DEBUG:  calling... tshark $flags_for_i -a \"duration:$CHECK_NETWORKSPANS_DURATION\" -a \"packets:$CHECK_NETWORKSPANS_PACKETS\" -w \"$CHECK_NETWORKSPANS_INTERFACES\".pcap -f \"$CHECK_NETWORKSPANS_FILTER\""
	echo "DEBUG: -Q omitted as debugging is enabled"
else
	make_tshark_quiet='-Q'
fi

tshark $flags_for_i -a "duration:$CHECK_NETWORKSPANS_DURATION" -a "packets:$CHECK_NETWORKSPANS_PACKETS" -w "$CHECK_NETWORKSPANS_INTERFACES".pcap -f "$CHECK_NETWORKSPANS_FILTER" $make_tshark_quiet

if [ ! -z "$CHECK_NETWORKSPANS_DEBUG" ]; then
	echo "DEBUG: listing dir... /bin/ls -lha";
	/bin/ls -lha
fi
